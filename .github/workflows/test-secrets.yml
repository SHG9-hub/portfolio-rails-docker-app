name: Test Secrets Configuration

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œç”¨

jobs:
  test-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test Secrets Configuration
        run: |
          echo "ğŸ” Testing secrets configuration..."
          echo "=================================="

          # å„secretã®å­˜åœ¨ç¢ºèªï¼ˆå€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          if [ -n "${{ secrets.RAILS_MASTER_KEY }}" ]; then
            echo "âœ… RAILS_MASTER_KEY: SET (${#RAILS_MASTER_KEY} characters)"
          else
            echo "âŒ RAILS_MASTER_KEY: NOT SET"
          fi

          if [ -n "${{ secrets.PGHOST }}" ]; then
            echo "âœ… PGHOST: SET (${{ secrets.PGHOST }})"
          else
            echo "âŒ PGHOST: NOT SET"
          fi

          if [ -n "${{ secrets.PGUSER }}" ]; then
            echo "âœ… PGUSER: SET (${{ secrets.PGUSER }})"
          else
            echo "âŒ PGUSER: NOT SET"
          fi

          if [ -n "${{ secrets.PGPASSWORD }}" ]; then
            echo "âœ… PGPASSWORD: SET (${#PGPASSWORD} characters)"
          else
            echo "âŒ PGPASSWORD: NOT SET"
          fi

          if [ -n "${{ secrets.PGDATABASE }}" ]; then
            echo "âœ… PGDATABASE: SET (${{ secrets.PGDATABASE }})"
          else
            echo "âŒ PGDATABASE: NOT SET"
          fi

          if [ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âœ… AWS_ACCESS_KEY_ID: SET"
          else
            echo "âŒ AWS_ACCESS_KEY_ID: NOT SET"
          fi

          if [ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âœ… AWS_SECRET_ACCESS_KEY: SET"
          else
            echo "âŒ AWS_SECRET_ACCESS_KEY: NOT SET"
          fi

          echo "=================================="
          echo "ğŸ¯ Test completed!"
        env:
          RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}

      - name: Test Docker Build Arguments
        run: |
          echo "ğŸ³ Testing Docker build with secrets..."
          echo "Building with the same arguments as production workflow..."

          # å®Ÿéš›ã®ãƒ“ãƒ«ãƒ‰ã¯ã—ãªã„ãŒã€å¼•æ•°ã®ç¢ºèª
          echo "Docker build command would be:"
          echo "docker build \\"
          echo "  --build-arg RAILS_MASTER_KEY=*** \\"
          echo "  --build-arg PGHOST=${{ secrets.PGHOST }} \\"
          echo "  --build-arg PGUSER=${{ secrets.PGUSER }} \\"
          echo "  --build-arg PGPASSWORD=*** \\"
          echo "  --build-arg PGDATABASE=${{ secrets.PGDATABASE }} \\"
          echo "  -t test-image ."

          # å¿…é ˆsecrets ã®æœ€çµ‚ç¢ºèª
          missing_secrets=()

          if [ -z "${{ secrets.RAILS_MASTER_KEY }}" ]; then
            missing_secrets+=("RAILS_MASTER_KEY")
          fi

          if [ -z "${{ secrets.PGHOST }}" ]; then
            missing_secrets+=("PGHOST")
          fi

          if [ -z "${{ secrets.PGUSER }}" ]; then
            missing_secrets+=("PGUSER")
          fi

          if [ -z "${{ secrets.PGPASSWORD }}" ]; then
            missing_secrets+=("PGPASSWORD")
          fi

          if [ -z "${{ secrets.PGDATABASE }}" ]; then
            missing_secrets+=("PGDATABASE")
          fi

          if [ ${#missing_secrets[@]} -eq 0 ]; then
            echo "ğŸ‰ All required secrets are properly configured!"
            echo "âœ… Ready for deployment!"
          else
            echo "âŒ Missing secrets detected:"
            for secret in "${missing_secrets[@]}"; do
              echo "   - $secret"
            done
            echo ""
            echo "Please configure missing secrets in:"
            echo "Repository Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
