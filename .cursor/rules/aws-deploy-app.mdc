---
description: 
globs: 
alwaysApply: false
---
GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’ç¢ºèªã—ã¦ã€app-deploymentã«å¿…è¦ãªã‚¿ã‚¹ã‚¯ã‚’ã¾ã¨ã‚ã¾ã™ã€‚**Dockerç’°å¢ƒã§ã®é–‹ç™ºã‚’å‰æã¨ã—ã¾ã™ã€‚**

# AWS Fargate æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‘ã‘ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚¿ã‚¹ã‚¯ (Dockerç’°å¢ƒå¯¾å¿œç‰ˆ)

## ğŸ“‹ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ç¾åœ¨ã®Dockerç’°å¢ƒã§é–‹ç™ºä¸­ã® `rails_docker_dev_v1` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’
AWS ECS Fargate + Parameter Store æ§‹æˆã§æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã®ã‚¿ã‚¹ã‚¯ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

## ğŸ³ Dockerç’°å¢ƒã§ã®ä½œæ¥­å‰æ

**ã™ã¹ã¦ã®Railsã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã®å½¢å¼ã§å®Ÿè¡Œã—ã¾ã™ï¼š**
```bash
docker compose run --rm web [command]
```

## ğŸ¯ ã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒæƒ…å ±

- **AWS ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: ap-northeast-1
- **ECR ãƒªãƒã‚¸ãƒˆãƒª**: `149465512111.dkr.ecr.ap-northeast-1.amazonaws.com/portfolio-rails-production`
- **ECS ã‚¯ãƒ©ã‚¹ã‚¿**: `portfolio-rails-production`
- **RDS ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: CloudFormation ã‹ã‚‰è‡ªå‹•å–å¾—
- **Parameter Store éšå±¤**: `/portfolio-rails/production/`

## ğŸš€ å®Ÿè¡Œé †åºã¨ã‚¿ã‚¹ã‚¯

### âœ… Phase 1: Secret Keys ç”Ÿæˆï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

#### Task 1.1: Rails Master Key ç¢ºèªãƒ»ç”Ÿæˆ (Dockerç’°å¢ƒ)
```bash
# ç¾åœ¨ã®master keyã‚’ç¢ºèª
docker compose run --rm web cat config/master.key

# ã‚‚ã—ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã€æ–°è¦ç”Ÿæˆ
docker compose run --rm web rails credentials:edit

# ç”Ÿæˆã•ã‚ŒãŸmaster keyã‚’è¨˜éŒ²ï¼ˆParameter Storeè¨­å®šã§ä½¿ç”¨ï¼‰
docker compose run --rm web sh -c "echo 'RAILS_MASTER_KEY='$(cat config/master.key)"
```

#### Task 1.2: Devise Secret Key ç”Ÿæˆ (Dockerç’°å¢ƒ)
```bash
# Deviseç”¨secret keyç”Ÿæˆ
docker compose run --rm web rails secret

# å‡ºåŠ›ã•ã‚ŒãŸå€¤ã‚’è¨˜éŒ²ï¼ˆParameter Storeè¨­å®šã§ä½¿ç”¨ï¼‰
echo "DEVISE_SECRET_KEY=[ç”Ÿæˆã•ã‚ŒãŸå€¤]"
```

**ğŸ“ å‡ºåŠ›**: ä»¥ä¸‹ã®å€¤ã‚’ãƒ¡ãƒ¢ã—ã¦ãã ã•ã„
- `RAILS_MASTER_KEY`: [å€¤]
- `DEVISE_SECRET_KEY`: [å€¤]

---

### âœ… Phase 2: Database è¨­å®šä¿®æ­£ âœ…å®Œäº†

#### Task 2.1: database.yml ä¿®æ­£ âœ…å®Œäº†
`config/database.yml` ã® production éƒ¨åˆ†ã¯æ—¢ã«ä¿®æ­£æ¸ˆã¿:

```yaml
production:
  <<: *default
  database: <%= ENV.fetch("PGDATABASE") { "portfoliorailsdb" } %>
  host: <%= ENV.fetch("PGHOST") %>
  username: <%= ENV.fetch("PGUSER") { "app" } %>
  password: <%= ENV.fetch("PGPASSWORD") %>
```

---

### âœ… Phase 3: æœ¬ç•ªç’°å¢ƒç”¨ Dockerfile æœ€é©åŒ–

#### Task 3.1: ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ Dockerfile ä½œæˆ
ç¾åœ¨ã® `Dockerfile` ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆ:

```dockerfile
# Build stage
FROM ruby:3.2.2-slim AS builder

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
    curl \
    git && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Gemfileã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Bundle install
COPY Gemfile Gemfile.lock ./
RUN bundle config set --local deployment 'true' && \
    bundle config set --local without 'development test' && \
    bundle install

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY . .

# ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ï¼ˆæœ¬ç•ªç’°å¢ƒç”¨ï¼‰
RUN RAILS_ENV=production \
    SECRET_KEY_BASE=dummy \
    bundle exec rails assets:precompile

# Production stage
FROM ruby:3.2.2-slim AS production

# ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã¿ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update -qq && \
    apt-get install -y --no-install-recommends \
    libpq5 \
    curl && \
    rm -rf /var/lib/apt/lists/* && \
    groupadd -r rails && useradd -r -g rails rails

WORKDIR /app

# Gemã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder /usr/local/bundle /usr/local/bundle

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã•ã‚ŒãŸã‚¢ã‚»ãƒƒãƒˆã‚’ã‚³ãƒ”ãƒ¼
COPY --from=builder --chown=rails:rails /app .

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
USER rails

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

EXPOSE 3000

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã«ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
CMD ["sh", "-c", "bundle exec rails db:migrate && bundle exec puma -C config/puma.rb"]
```

---

### âœ… Phase 4: æœ¬ç•ªç’°å¢ƒè¨­å®šèª¿æ•´

#### Task 4.1: production.rb è¨­å®šèª¿æ•´
`config/environments/production.rb` ã«ä»¥ä¸‹ã®è¨­å®šã‚’è¿½åŠ /ä¿®æ­£:

```ruby
# é™çš„ãƒ•ã‚¡ã‚¤ãƒ«é…ä¿¡ã‚’æœ‰åŠ¹åŒ–ï¼ˆFargateã§ã¯Webã‚µãƒ¼ãƒãƒ¼ãªã—ï¼‰
config.public_file_server.enabled = true

# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š
config.log_level = ENV.fetch("RAILS_LOG_LEVEL", "info")

# ãƒ›ã‚¹ãƒˆè¨±å¯è¨­å®šï¼ˆALBçµŒç”±ã®ã‚¢ã‚¯ã‚»ã‚¹ç”¨ï¼‰
config.hosts.clear # é–‹ç™ºæ™‚ã¯å…¨è¨±å¯ã€æœ¬ç•ªã§ã¯é©åˆ‡ã«è¨­å®š

# Master keyå¿…é ˆè¨­å®š
config.require_master_key = true
```

#### Task 4.2: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
**1. ãƒ«ãƒ¼ãƒˆè¿½åŠ **ï¼ˆ`config/routes.rb`ï¼‰:

```ruby
Rails.application.routes.draw do
  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  get '/health', to: 'health#check'

  # æ—¢å­˜ã®ãƒ«ãƒ¼ãƒˆ...
end
```

**2. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆ**ï¼ˆ`app/controllers/health_controller.rb`ï¼‰:

```ruby
class HealthController < ApplicationController
  def check
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒã‚§ãƒƒã‚¯
    ActiveRecord::Base.connection.execute('SELECT 1')

    render json: {
      status: 'ok',
      timestamp: Time.current,
      version: Rails.version
    }, status: :ok
  rescue => e
    render json: {
      status: 'error',
      error: e.message,
      timestamp: Time.current
    }, status: :service_unavailable
  end
end
```

---

### âœ… Phase 5: GitHub Actions CI/CD è¨­å®š

#### Task 5.1: GitHub Actions workflow ä½œæˆ
`.github/workflows/deploy.yml` ã‚’ä½œæˆ:

```yaml
name: Deploy to AWS ECS Fargate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: ap-northeast-1
  ECR_REPOSITORY: portfolio-rails-production
  ECS_CLUSTER: portfolio-rails-production
  ECS_SERVICE: portfolio-rails-production-service

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: password
          POSTGRES_DB: app_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.2
          bundler-cache: true

      - name: Set up database
        env:
          RAILS_ENV: test
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: password
          PGDATABASE: app_test
        run: |
          bundle exec rails db:create db:migrate

      - name: Run tests
        env:
          RAILS_ENV: test
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: password
          PGDATABASE: app_test
        run: bundle exec rspec

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Update ECS service
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --force-new-deployment
```

#### Task 5.2: GitHub Secrets è¨­å®š
ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets and variables ã§ä»¥ä¸‹ã‚’è¨­å®š:

- `AWS_ACCESS_KEY_ID`: [IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼]
- `AWS_SECRET_ACCESS_KEY`: [IAM ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼]

---

## ğŸ“‹ å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: Secret Keys âœ…

- [ ] Rails master key ç¢ºèª/ç”Ÿæˆ
- [ ] Devise secret key ç”Ÿæˆ
- [ ] ä¸¡æ–¹ã®å€¤ã‚’è¨˜éŒ²

### Phase 2: Database è¨­å®š âœ…

- [ ] `config/database.yml` ä¿®æ­£
- [ ] ç’°å¢ƒå¤‰æ•°åçµ±ä¸€ï¼ˆPGHOST, PGUSER, PGPASSWORD, PGDATABASEï¼‰

### Phase 3: Dockerfile æœ€é©åŒ– âœ…

- [ ] ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰å®Ÿè£…
- [ ] ã‚¢ã‚»ãƒƒãƒˆãƒ—ãƒªã‚³ãƒ³ãƒ‘ã‚¤ãƒ«è¿½åŠ 
- [ ] é root ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè£…

### Phase 4: æœ¬ç•ªç’°å¢ƒè¨­å®š âœ…

- [ ] `production.rb` èª¿æ•´
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
- [ ] ãƒ«ãƒ¼ãƒˆè¨­å®šè¿½åŠ 

### Phase 5: CI/CD è¨­å®š âœ…

- [ ] GitHub Actions workflow ä½œæˆ
- [ ] GitHub Secrets è¨­å®š

---

**ä½œæ¥­å®Œäº†å¾Œã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒªãƒã‚¸ãƒˆãƒªã«ç§»ã£ã¦ç¶šãã®ä½œæ¥­ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚**